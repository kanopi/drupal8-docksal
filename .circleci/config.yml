version: 2

jobs:
  build:
    working_directory: /home/agent/build
    docker:
      - image: seandietrich/ci-agent:base
    environment:
       BASH_ENV: /home/agent/.bashrc  # Tell CircleCI where to read the shared build environment variables from
    steps:
      - checkout
      - run:
          name: Configure local build environment
          command: |
            touch $BASH_ENV
            echo 'source build-env' >> $BASH_ENV
      - run:
          name: Sandbox provisioning
          command: |
            build-init
            slack "Started sandbox build for branch *${GIT_BRANCH_NAME}*"
            ssh docker-host "cd $REMOTE_BUILD_DIR && fin init"
            slack "Completed sandbox build for branch *${GIT_BRANCH_NAME}*:\n<http://${DOMAIN}|http://${DOMAIN}>"

workflows:
  version: 2
  default-workflow:
    jobs:
      - build:
          context: org-global  # Load org level environment variables from CircleCI
